import { NextRequest, NextResponse } from 'next/server'; import { getClient } from '@/lib/db'; import { requireUser } from '@/lib/auth.signed'; import { coarseCell } from '@/lib/geo'; export async function POST(req:NextRequest){ let userId:string; try{ const u=await requireUser(); userId=u.id; }catch{ return NextResponse.json({error:'unauthorized'},{status:401}); } const prisma=await getClient(); const body=await req.json().catch(()=>null); if(!body) return NextResponse.json({error:'invalid'},{status:400}); let { lat, lng, status, capacity }=body as any; if(typeof status!=='string'||!['ONLINE','OFFLINE','BUSY'].includes(status)) status='ONLINE'; if(typeof capacity!=='number'||capacity<1||capacity>5) capacity=1; let cell:string|null=null; if(typeof lat==='number'&&typeof lng==='number'){ cell=coarseCell(lat,lng); } await (prisma as any).helperPresence.upsert({ where:{ helperId:userId }, update:{ lat:lat??null, lng:lng??null, geoHash6:cell, status, capacity }, create:{ helperId:userId, lat:lat??null, lng:lng??null, geoHash6:cell, status, capacity } }); return NextResponse.json({ok:true}); }
